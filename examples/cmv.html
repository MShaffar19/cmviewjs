<html>
<head>

</head>

<body>
	<h1><i>Protein Contact Map</i></h1>
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="ngl.dev.js"></script>
	<script type = "text/javascript" src = "cmsvg.js"></script>
	<script type = "text/javascript" src = "cmngl.js"></script>
	<script type = "text/javascript" src = "cmcontroller.js"></script>
	<script src=//cdn.bio.sh/msa/1.0/msa.min.gz.js></script>
	<div id = "container" style = "width:1400px; height: 900px">
		<div id="nglviewport" style="width:700px; height:700px; float: right;"></div>
		<div id="svgviewport" style="width:700px; height:700px; float: left;"></div>

		<div class = "panel" >
			<span class="Text" id="clickedatom" style="display: inline-block; vertical-align: middle;">
				Clicked on NGL to get atom information here.
			</span> 
		</div>

		<p>Enter PDB ID to show contact map:</p>

		<div id="form">
			<form id ="frm1">
			PDB ID: <input type="text" name="pdbid" id="pdbid" value="1smt">
			</form>

			<form id ="frm2">
			Chain: <input type="text" name="chain" id="chain" value="A">
			</form>		

			<form id ="frm3">
			Cutoff: <input type="number" name="cutoff" id="cutoff" value= "8" >
			</form>					

			<input id="submit" value="Submit" type="button">
			<input id="zoomon" value="Zoomon" type="button">
			<input id="zoomoff" value="Zoomoff" type="button">
		</div>

		<p>Protein contact map represents the distance between all possible amino acid residue pairs of a three-dimensional protein structure using a binary-dimensional matrix.</p>

	</div>
	

  
<script>



//testing MSA









/*var fasta = ">seq1\n\
ACT-TTTTTTG\n\
>seq2\n\
GGCCTACGG\n";
*/

/*
var fasta = ">seq1\n\VLSPADKTNVKAAWGKVGAHAGEYGAEALERMFLSFPTTKTYFPHFDL------SHGSAQVKGHGKKVADALTNAVAHVDDMPNALSALSDLHAHKLRVDPVNFKLLSHCLLVTLAAHLPAEFTPAVHASLDKFLASVSTVLTSKYR\n\>seq2\n\HLTPEEKSAVTALWGKV--NVDEVGGEALGRLLVVYPWTQRFFESFGDLSTPDAVMGNPKVKAHGKKVLGAFSDGLAHLDNLKGTFATLSELHCDKLHVDPENFRLLGNVLVCVLAHHFGKEFTPPVQAAYQKVVAGVANALAHKYH\n";

var seqs = msa.io.fasta.parse(fasta);
console.log(seqs)

var m = msa({
	el: document.getElementById("svgviewport"),
    seqs: seqs
});
//console.log(m.seqs.at(0).get("seq"));
m.render();*/

/*
var xhr = require("xhr");
var gffParser = require("biojs-io-gff");
var m = msa({el: rootDiv, importURL: "https://raw.githubusercontent.com/wilzbach/msa/master/test/dummy/samples/p53.clustalo.clustal");

// add features
xhr("./data/fer1.gff3", function(err, request, body) {
  var features = gffParser.parseSeqs(body);
  m.seqs.addFeatures(features);
});

// or even more
xhr("./data/fer1.gff_jalview", function(err, request, body) {
  var features = gffParser.parseSeqs(body);
  m.seqs.addFeatures(features);
});*/




/*var seq1 = "VLSPADKTNVKAAWGKVGAHAGEYGAEALERMFLSFPTTKTYFPHFDLSHGSAQVKGHGKKVADALTNAVAHVDDMPNALSALSDLHAHKLRVDPVNFKLLSHCLLVTLAAHLPAEFTPAVHASLDKFLASVSTVLTSKYR";
var seq2 = "VHLTPEEKSAVTALWGKVNVDEVGGEALGRLLVVYPWTQRFFESFGDLSTPDAVMGNPKVKAHGKKVLGAFSDGLAHLDNLKGTFATLSELHCDKLHVDPENFRLLGNVLVCVLAHHFGKEFTPPVQAAYQKVVAGVANALAHKYH";
var seqarry = [];
seqarry[0] = seq1;
seqarry[1] = seq2;*/

//input
var align1 = "-VLSPADKTNVKAAWGKVGAHAGEYGAEALERMFLSFPTTKTYFPHFDL------SHGSAQVKGHGKKVADALTNAVAHVDDMPNALSALSDLHAHKLRVDPVNFKLLSHCLLVTLAAHLPAEFTPAVHASLDKFLASVSTVLTSKYR";
var align2 = "VHLTPEEKSAVTALWGKV--NVDEVGGEALGRLLVVYPWTQRFFESFGDLSTPDAVMGNPKVKAHGKKVLGAFSDGLAHLDNLKGTFATLSELHCDKLHVDPENFRLLGNVLVCVLAHHFGKEFTPPVQAAYQKVVAGVANALAHKYH";
var alignarry = [];
alignarry[0] = align1;
alignarry[1] = align2;
var alignlength = Number(align1.length);
//var seq1length = 141;
//var seq2length = 146;

console.log(alignlength);

//function
var alignToSeq = [];
var seqToAlign = [];
for(var a = 0; a < alignarry.length; a++){
	var index1 = 0;
	var index2 = 0;
	var map1 = [];
	var map2 = [];
	for(var i = 0; i < alignlength; i++){
		var currentalign = alignarry[a];
		var currentchar = currentalign[i];

		if(currentchar !== "-"){
			map1[i] = index1;
			index1++;

			map2[index2] = i;
			index2++;
		}
		else{
			map1[i] = -1;
		}
	}
	alignToSeq.push(map1);
	seqToAlign.push(map2);
}
console.log("AlignToSeq:");
console.log(alignToSeq);
console.log("SeqToAlign:");
console.log(seqToAlign);

var testurl = "http://localhost:8000/examples/4hhb.json";
d3.json(testurl, function(data){
	console.log(data);
});
/*
var map2 = [];
var index2 = 0;
for(var i = 0; i < maxLength; i++){
	var currentseq2 = seq2[i];

	if(index2 <= seq2length && currentseq2 !== "-"){
		map2[i] = index2;
		index2++;
	}
}*/

//console.log(map1);
//console.log(map2);








//changing the viewport size base on user innerWidth and innerHeight.
//console.log("width: "+ window.innerWidth);
//console.log("height: "+window.innerHeight);
var windowW = window.innerWidth;
var windowH = window.innerHeight;
var maxLength = Math.max(windowH, windowW);
//console.log("Max: "+ maxLength);
maxLength = maxLength*0.5;

//adjust div with user window screen
var inputlength = maxLength+"px";
var max2 = maxLength*2;
var inputlength2 = max2+"px";
var nglstr = "width:"+inputlength+"; height:"+inputlength+"; float: right;";
var svgstr = "width:"+inputlength+"; height:"+inputlength+"; float: left;";
var containerstr = "width:"+inputlength2+"; height:"+inputlength;
document.getElementById('container').setAttribute("style", containerstr);
document.getElementById('nglviewport').setAttribute("style", nglstr);
document.getElementById('svgviewport').setAttribute("style", svgstr);

//<body bgcolor="#07C7EE">
var loadedtag = 0;
var nglobj, svgobj, cmcontroller;

function pdbinput(){
	var pdbid = document.getElementById('pdbid').value;
	var chainName = document.getElementById('chain').value;
	var cutoff = document.getElementById('cutoff').value;
	chainName = chainName.toUpperCase();
	console.log("PDB ID: " + pdbid);
	console.log("Chain: " + chainName);
	console.log("Cutoff: " + cutoff);

	//svgurl
	//"http://localhost:8000/examples/5sx3.json"
	var str1 = "http://localhost:8000/examples/";
	var str2 = ".json";
	var svgurl = str1.concat(pdbid);
	svgurl = svgurl.concat(str2);
	console.log(svgurl);

	//nglurl
	//"rcsb://5sx3.mmtf"
	var str4 = "rcsb://";
	var str5 = ".mmtf";
	var nglurl = str4.concat(pdbid);
	nglurl = nglurl.concat(str5);
	console.log(nglurl);



	if(loadedtag === 1){
		//d3.select("svg").remove();
		document.getElementById("svgviewport").innerHTML = "";
		document.getElementById("nglviewport").innerHTML = "";
	}



	//creating promise and timeout so that ngl load first before loading svg
	/*var promise = new Promise(function(resolve, reject){
		var nglobj = new cmNgl("ngl1", "nglviewport", nglurl, chainName);
		nglobj.loadngl();


		resolve(nglobj);
		reject(Error("Fail"));		
	});

	promise.then(function(result){
		setTimeout(function(){
			var svgobj = new cmSvg("svg1", result, svgurl);
			var cmcontroller = new cmController("cmctr1", svgobj, result);
			cmcontroller.ctloadcmsvg(1);
		}, 1000);
	}, function(err){
		console.log(err);
	});*/
	

	/*
	nglobj = new cmNgl("clickedatom" ,"nglviewport", nglurl, chainName, cutoff);
	//cmcontroller;
	nglobj.loadngl().then(function(){
		var svgobj1 = new cmSvg("svgviewport", nglobj, svgurl, chainName);
		svgobj = svgobj1;
		cmcontroller = new cmController(svgobj, nglobj);
		cmcontroller.ctloadcmsvg(1, maxLength);
		//cmcontroller.zoom(0);
		//cmcontroller.brush(1);
	});*/

	cmcontroller = new cmController("clickedatom", "nglviewport", nglurl, chainName, cutoff, "svgviewport", svgurl, maxLength);

	//cmcontroller.ctloadcmsvg(1, maxLength);

	loadedtag = 1;

}

var inputpdbbtn = document.getElementById('submit');
inputpdbbtn.addEventListener('click', pdbinput);


//registering "Enter" for all three input text field
document.getElementById("frm3").addEventListener("keydown", function(event) {
	if(event.keyCode === 13) {
		event.preventDefault();
		document.getElementById("submit").click();
	}
});
document.getElementById("frm2").addEventListener("keydown", function(event) {
	if(event.keyCode === 13) {
		event.preventDefault();
		document.getElementById("submit").click();
	}
});
document.getElementById("frm1").addEventListener("keydown", function(event) {
	if(event.keyCode === 13) {
		event.preventDefault();
		document.getElementById("submit").click();
	}
});

function zoomon(){
	cmcontroller.zoom(1);
	cmcontroller.brush(0);
}

var zoomonbtn = document.getElementById('zoomon');
zoomonbtn.addEventListener('click', zoomon);


function zoomoff(){
	cmcontroller.zoom(0);
	cmcontroller.brush(1);
}

var zoomoffbtn = document.getElementById('zoomoff');
zoomoffbtn.addEventListener('click', zoomoff);

</script>



</body>
</html>